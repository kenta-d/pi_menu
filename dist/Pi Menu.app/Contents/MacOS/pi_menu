#!/bin/bash

# Pi Menu macOS Application Launcher
# Boss1 Agent ã®é–‹ç™ºã«ã‚ˆã‚‹ãƒ¢ãƒ€ãƒ³ãªå††å½¢ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ãƒ³ãƒãƒ£ãƒ¼

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ«ã®ãƒ‘ã‚¹è¨­å®š
BUNDLE_PATH="$(dirname "$0")/.."
RESOURCES_PATH="$BUNDLE_PATH/Resources"
PYTHON_APP="$RESOURCES_PATH/pi_menu"

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®š
cd "$RESOURCES_PATH"

# Pythonç’°å¢ƒã®ç¢ºèª
echo "ðŸ” Pythonç’°å¢ƒã‚’ç¢ºèªä¸­..."

# ã‚·ã‚¹ãƒ†ãƒ ã®Python3ã‚’ä½¿ç”¨
PYTHON_CMD="python3"

# PyQt6ã®ç¢ºèª
if ! $PYTHON_CMD -c "import PyQt6" 2>/dev/null; then
    # AppleScriptã§ã‚¨ãƒ©ãƒ¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    osascript -e 'display dialog "PyQt6ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nå¿…è¦ãªä¾å­˜é–¢ä¿‚:\nâ€¢ PyQt6\n\nã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•:\nbrew install pyqt@6\n\nã¾ãŸã¯:\npipx install PyQt6" with title "Pi Menu - ä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼" buttons {"OK"} default button "OK" with icon stop'
    exit 1
fi

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
if [ ! -f "$RESOURCES_PATH/config.json" ]; then
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½œæˆ
    echo "ðŸ“‹ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆä¸­..."
    cat > "$RESOURCES_PATH/config.json" << 'EOF'
{
    "apps": [
        {
            "name": "Finder",
            "command": "open /System/Library/CoreServices/Finder.app",
            "icon": "",
            "favorite": true
        },
        {
            "name": "Safari",
            "command": "open /Applications/Safari.app",
            "icon": "",
            "favorite": true
        },
        {
            "name": "Mail",
            "command": "open /Applications/Mail.app",
            "icon": "",
            "favorite": true
        }
    ]
}
EOF
fi

# macOSç”¨ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
export QT_QPA_PLATFORM="cocoa"
export PYTHONPATH="$RESOURCES_PATH:$PYTHONPATH"

# Pi Menuã‚’å®Ÿè¡Œ
echo "ðŸš€ Pi Menu ã‚’èµ·å‹•ä¸­..."
exec $PYTHON_CMD "$PYTHON_APP/main_safe.py"